# Template file for 'opencl-amdgpu-standalone'
pkgname=opencl-amdgpu-standalone
_major=20.40
_minor=1147287
version=${_major}.${_minor}
revision=1
build_style=fetch
only_for_archs="x86_64"
nostrip="yes"
restricted="yes"
hostmakedepends="wget tar xz"
depends="ocl-icd libdrm"
short_desc="Proprietary standalone opencl stack for amdgpu"
maintainer="lemmi <lemmi@nerd2nerd.org>"
license="AMD-GPU-PRO"
homepage="https://amd.com"
distfiles="https://drivers.amd.com/drivers/linux/amdgpu-pro-${_major}-${_minor}-ubuntu-18.04.tar.xz"
checksum=1b364f6669bbbefbc3136d52a9ae8ee31cd56eb62900f93eac49cc215ad50d86

fetch_cmd='wget --referer https://www.amd.com/ -N'

do_build() {
	local shared="opt/amdgpu-pro/lib/x86_64-linux-gnu"
	local srcdir="$wrksrc"
	local prefix="amdgpu-pro-"
	local postfix="-ubuntu-18.04"
	local major="$_major"
	local minor="$_minor"

	tar xf "${prefix}${major}-${minor}${postfix}.tar.xz"

    mkdir "${srcdir}/opencl"
    cd "${srcdir}/opencl"
    ar x "${srcdir}/${prefix}${major}-${minor}${postfix}/opencl-amdgpu-pro-icd_${major}-${minor}_amd64.deb"
    tar xvJf data.tar.xz
	ar x "${srcdir}/${prefix}${major}-${minor}${postfix}/opencl-amdgpu-pro-comgr_${major}-${minor}_amd64.deb"
	tar xvJf data.tar.xz

	ar x "${srcdir}/amdgpu-pro-${major}-${minor}-ubuntu-18.04/amdgpu-pro-core_${major}-${minor}_all.deb"
	tar xvJf data.tar.xz
	ar x "${srcdir}/amdgpu-pro-${major}-${minor}-ubuntu-18.04/amdgpu-core_${major}-${minor}_all.deb"
	tar xvJf data.tar.xz

}

do_install() {
	local shared="opt/amdgpu-pro/lib/x86_64-linux-gnu"
	local srcdir="${wrksrc}"
	local pkgdir="${DESTDIR}"

    mv "${srcdir}/opencl/etc" "${pkgdir}/"
    mkdir -p ${pkgdir}/usr/lib
    mv "${srcdir}/opencl/${shared}/libamdocl64.so" "${pkgdir}/usr/lib/"
	mv "${srcdir}/opencl/${shared}/libamd_comgr.so" "${pkgdir}/usr/lib/"

    mkdir -p "${pkgdir}/opt/amdgpu/share/libdrm"
    cd "${pkgdir}/opt/amdgpu/share/libdrm"
    ln -s /usr/share/libdrm/amdgpu.ids amdgpu.ids
}

